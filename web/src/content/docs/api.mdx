---
title: "API Reference - Volcano SDK"
---

# API Reference

API documentation for Volcano SDK: agent creation, step types, results, and utility functions.

## agent(options?): AgentBuilder

Create an agent workflow builder.

```typescript
import { agent, llmOpenAI } from "volcano-sdk";

const llm = llmOpenAI({ apiKey: process.env.OPENAI_API_KEY! });

const myAgent = agent({
  llm,
  instructions: "You are a helpful assistant",
  timeout: 60,
  retry: { retries: 3 }
});
```

### Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `llm` | LLMHandle | - | Default LLM provider for all steps |
| `instructions` | string | - | Global system instructions |
| `timeout` | number | 60 | Default timeout per step (seconds) |
| `retry` | RetryConfig | `{ retries: 3 }` | Retry configuration |
| `contextMaxChars` | number | 20480 | Soft cap for injected context size |
| `contextMaxToolResults` | number | 8 | Number of recent tool results to include |

### Methods

#### Basic Methods

| Method | Description |
|--------|-------------|
| `.then(step)` | Add a sequential step to the workflow |
| `.resetHistory()` | Clear context/history for subsequent steps |
| `.run(log?)` | Execute workflow and return all results |
| `.stream(log?)` | Execute workflow and yield results incrementally |

#### Advanced Pattern Methods

| Method | Description |
|--------|-------------|
| `.parallel(steps)` | Execute steps concurrently (array or dict mode) |
| `.branch(condition, branches)` | Conditional if/else routing |
| `.switch(selector, cases)` | Multi-way branching with default |
| `.while(condition, body, opts?)` | Loop until condition is false |
| `.forEach(items, body)` | Iterate over array of items |
| `.retryUntil(body, success, opts?)` | Retry until success condition is met |
| `.runAgent(subAgent)` | Compose and run sub-agents |

## Step Types

Volcano SDK supports three types of steps:

### LLM-Only Step

Generate text with an LLM without tools:

```typescript
{
  prompt: string;
  llm?: LLMHandle;
  instructions?: string;
  timeout?: number;
  retry?: RetryConfig;
  contextMaxChars?: number;
  contextMaxToolResults?: number;
  pre?: () => void;
  post?: () => void;
}
```

### Automatic MCP Tool Selection

Let the LLM automatically choose which tools to call:

```typescript
{
  prompt: string;
  mcps: MCPHandle[];
  llm?: LLMHandle;
  instructions?: string;
  timeout?: number;
  retry?: RetryConfig;
  contextMaxChars?: number;
  contextMaxToolResults?: number;
  pre?: () => void;
  post?: () => void;
}
```

### Explicit MCP Tool Call

Call a specific tool directly:

```typescript
{
  mcp: MCPHandle;
  tool: string;
  args?: Record<string, any>;
  prompt?: string;         // Optional LLM step before tool
  llm?: LLMHandle;
  instructions?: string;
  timeout?: number;
  retry?: RetryConfig;
  contextMaxChars?: number;
  contextMaxToolResults?: number;
  pre?: () => void;
  post?: () => void;
}
```

### Common Step Fields

| Field | Type | Description |
|-------|------|-------------|
| `llm` | LLMHandle | Override the LLM for this step |
| `instructions` | string | Override system instructions for this step |
| `timeout` | number | Step timeout in seconds (overrides agent default) |
| `retry` | RetryConfig | Retry config for this step (overrides agent default) |
| `pre` | () => void | Hook called before step execution |
| `post` | () => void | Hook called after successful step execution |

## Step Results

Each step returns a `StepResult` object with execution details:

```typescript
type StepResult = {
  // Basic fields
  prompt?: string;
  llmOutput?: string;

  // Timing metrics (milliseconds)
  durationMs?: number;        // Total step wall time
  llmMs?: number;             // Time spent in LLM calls

  // MCP tool results (explicit call)
  mcp?: {
    endpoint: string;
    tool: string;
    result: any;
    ms?: number;              // Tool execution time
  };

  // MCP tool calls (automatic selection)
  toolCalls?: Array<{
    name: string;
    endpoint: string;
    result: any;
    ms?: number;              // Tool execution time
  }>;

  // Parallel execution results
  parallel?: Record<string, StepResult>;
  parallelResults?: StepResult[];

  // Aggregated metrics (on final step only)
  totalDurationMs?: number;
  totalLlmMs?: number;
  totalMcpMs?: number;
};
```

### Example Usage

```typescript
const results = await agent({ llm })
  .then({ prompt: "Analyze sentiment", mcps: [analytics] })
  .then({ prompt: "Generate summary" })
  .run();

// Access first step results
console.log(results[0].prompt);        // "Analyze sentiment"
console.log(results[0].llmOutput);     // LLM response
console.log(results[0].toolCalls);     // Tools that were called
console.log(results[0].durationMs);    // Step duration
console.log(results[0].llmMs);         // LLM time

// Access aggregated metrics (on last step)
const last = results[results.length - 1];
console.log(last.totalDurationMs);     // Total workflow time
console.log(last.totalLlmMs);          // Total LLM time
console.log(last.totalMcpMs);          // Total MCP time
```

## RetryConfig

Configuration for retry behavior:

```typescript
type RetryConfig = {
  delay?: number;      // Seconds to wait between retries (mutually exclusive with backoff)
  backoff?: number;    // Exponential factor (waits 1s, factor^n each retry)
  retries?: number;    // Total attempts including first (default: 3)
};
```

### Examples

```typescript
// Immediate retry
{ retries: 3 }

// Delayed retry (wait 20s between attempts)
{ delay: 20, retries: 3 }

// Exponential backoff (1s, 2s, 4s, 8s)
{ backoff: 2, retries: 4 }
```

## Utility Functions

### mcp(url, options?): MCPHandle

Create an MCP handle for a tool server with optional authentication:

```typescript
import { mcp } from "volcano-sdk";

// No authentication
const astro = mcp("http://localhost:3211/mcp");

// OAuth authentication
const protectedMcp = mcp("https://api.example.com/mcp", {
  auth: {
    type: 'oauth',
    clientId: 'your-client-id',
    clientSecret: 'your-client-secret',
    tokenEndpoint: 'https://api.example.com/oauth/token'
  }
});

// Bearer token
const bearerMcp = mcp("https://api.example.com/mcp", {
  auth: {
    type: 'bearer',
    token: 'your-bearer-token'
  }
});
```

**MCP Specification:** Per the official MCP spec, authentication uses OAuth 2.1. Volcano supports OAuth (automatic token acquisition) and Bearer (custom tokens).

### discoverTools(handles): Promise\<ToolDefinition\[\]\>

Manually discover tools from MCP servers:

```typescript
import { discoverTools, mcp } from "volcano-sdk";

const handles = [
  mcp("http://localhost:3211/mcp"),
  mcp("http://localhost:3212/mcp")
];

const tools = await discoverTools(handles);
console.log(tools); // Array of tool definitions
```

## Type Reference

### LLMHandle

```typescript
type LLMHandle = {
  model: string;
  gen(prompt: string): Promise<string>;
  genWithTools(prompt: string, tools: ToolDefinition[]): Promise<LLMToolResult>;
  genStream?(prompt: string): AsyncGenerator<string, void, unknown>;
};
```

### MCPHandle

```typescript
type MCPHandle = {
  id: string;
  url: string;
};
```

### ToolDefinition

```typescript
type ToolDefinition = {
  name: string;
  description: string;
  parameters: any;        // JSON Schema
  mcpHandle?: MCPHandle;
};
```
